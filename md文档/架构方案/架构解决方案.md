架构解决方案

视频：https://www.bilibili.com/video/BV1LB4y1Q7Zo?p=38&vd_source=0ee4a5fcc4ed2246ba902aa714c4428b

## 一、分库分表

### 1. 如何支持多个分片键查询





## 二、高可用

### 2.1 依赖放通降级

#### 2.1.1 服务放通

比如用户鉴权中心出问题，提供基于短信，邮件，验证码，历史登录记录，缓存其他能证明用户信息等操作放通登录

#### 2.1.2 缓存数据

依赖服务异常，通过缓存查缓存，同时可以实现自动恢复，熔断器等操作

#### 2.1.3 redis降级

redis宕机时，降级到JVM缓存，实时监听redis的心跳，保障服务及时恢复

不可用达到某个阈值后，切换本地缓存，避免缓存击穿、缓存雪崩

### 2.2 过载控制

#### 2.2.1 接口过载

接口自动流控

#### 2.2.2 数据库SQL流控

对慢SQL进行流控，提供数据库引擎侧的限流能力，用户在数据库管理平台配置限流规则

#### 2.2.3 mybatis文件 慢SQL扫描

codecheck对 mybatis文件进行规则扫描，识别风险，减少发布后的慢SQL的问题

#### 2.2.4 负载不均衡

由于负载不均衡导致集群不分示例OOM，自研限流模块精细化控制流程，通过重试使各示例负载均衡

#### 2.2.5 数据库流量过载

读写分离，读从库，减轻主库压力和IO

#### 2.2.6 过载之熔断

调用方主动停止调用

### 2.3 弹性

#### 2.3.1 容器弹性伸缩

根据业务需求和策略，经济地自动调整计算资源的管理服务（如实例个数）

高可用&节省资源（业务量低时，使用较少实例）

触发条件：CPU使用率、内存使用率、每秒http请求量、每分钟所有请求平均响应时长、JVM Heap使用率、线程池使用率、老年代GC耗时占比等

推荐使用 CPU使用率 & 每秒HTTP请求数

阈值配置推荐： 

CPU使用率配置：大于等于峰值CPU使用率 且<90% 

每秒HTTP请求数：稍大于峰值QPS       

峰值QPS计算:( 总PV数 * 80% ) / ( 每天秒数 * 20% ) = 峰值时间每秒请求数(QPS)

### 2.4 爆炸半径控制

### 2.5 容灾多活

#### 2.5.1  网关双通道 

xx1.com 故障由业务代码自动切换 xx2.com 副集群

#### 2.5.2 redis集群双活同步

情况：redis有两个region的集群，之间数据是不同步的，只有初始化时一样

解决方案：通过aop拦截当前region的redis操作，然后异步消息队列 kafka/rocketMq 发送到另一个region的redis集群进行数据还原操作，实现增量数据更新

优势： 对代码侵入性小：引入组件后，只需增加配置信息，无需开发额外代码

#### 2.5.3 文件上传桶双写

上传时双写到两个regin的桶，单边写入，定时任务同步到另一边

### 2.6 数据可靠性

数据库建表语句和数据语句，分库导入到其他集群，保证可恢复

### 2.7 极限生存

个人开发环境不可用，切换个人安全PC啥的

### 2.8 变更管理

灰度发布等流水线操作 设置特定人员操作

### 2.9 故障发现

故障监控告警，关键作业场景和作业流的核心页面，数据

### 3.0 故障恢复

配合健康检测，使容器能够故障自愈能力，自动重启啥的
