项目简历详解



## 华为

1.对网关进行 **redis 降级整改**，使用 spring acurator 监控健康逻辑，配合 timer 定时任务+aop+原子类实现 redis 异常快速断连，不影响业务，只要有一个主节点失败就断连

详解： 定时任务每分钟调一次， 如果有两次主节点连续失败，就断连。

​			之前是用AtomicInteger 后面acurator出问题后就不能用这个了

​			使用两个 copyOnWriteList ，前一次，前前一次， 每个list记录出问题的节点的master IP，每次将前一次的list复制到前前一次的list，如果两个list同时出现相同的master节点，说明某个master节点连续两次出现问题，判断开启降级   ->  修改一个AtimocBoolean的值， aop切redisUtil如果这个值=false则抛出一个异常，redisUtil 所有方法默认都会  tryCatch异常，实现redis不阻塞 

​		如果两个list都为空，说明此时已经恢复，则恢复AtimocBoolean的值

​	

​	slave不是会自动切换上去么？为什么要要整个断？   系统比较重要，保证完全可用性；BUG分区了，salve没有主背切换

2.对用户登录信息获取系统宕机的高可用演练，设计**熔断器降级模块**，redis 存储用户短期 token 信息，闭路开路实现开启降级后**自动恢复**，判断 IP 等实现安全性

详解： 公司用户中心爆了，能让**最近登陆**过的用户，直接刷新还能访问系统。注意：如果用户换电脑或者清空了前端缓存就不行了

​		还有其他方案，比如手机登录的方式。正常原先登陆逻辑是输入用户名密码到用户中心获取token

​		鉴权网关，所有请求都会通过网关，用户之前登陆成功的时候会把  某个能独立标识用户的XXX-ID(这个ID正常来说是不用的，投机取巧) 发送到网关，网关会 redis存储， 并存储相关的IP信息，   前端也会缓存相关信息

​		熔断器模块是要在运维平台开启定时任务的， 演练开始时，宕机后，开启熔断器模块

​		运维逻辑图  闭路 -> 半开(异步去调用用户系统，判断成功路)

​							半开失败 -> 闭路

​							半开成功  -> 开路



采用时间区间的方式，比如定时任务调用 close()五分钟内不往下做，redis存 xxx_close: 时间戳

如果超过5分钟了，存xxx_half：时间戳   此时会去用计数器判断用户系统是否恢复，如果5分钟调用率没有100%则说明没恢复，会重新回到闭路状态， 此时 删除xxx_half,   更新xxx_close为新的时间戳

如果half恢复率是100% 则新建 open状态，恢复

close()  调用close()闭路，会开启一个redis  switch开关，代码关键位置判断这个开关是否打开，打开会使用redis去获取用户信息，鉴权，使得有前端有缓存的用户能鉴权通过直接跳过登陆访问系统。

​		代码逻辑会调用一次用户系统，如果用户真的失败了,会新建close时间戳，进入闭路状态，这时return true， 运维平台会进入half定时调用逻辑

​		如果当前时间距离闭路时间没大于5分钟，return false;  让运维平台持续调这个接口；

​		如果>5分钟，return true,让平台调第二个接口

half()    新建xxx_half，并异步调用，如果5分钟内几次调用都成功，则return true -> open

​			if 距离xxx_half>5 分钟， 说明半开失败，return flase 重新进入闭路状态 

open()  再次调用用户系统，如果失败则进入闭路状态，否则自循环

这演练其实更多是为了配合，真实情况一般不开启自动开启熔断器的逻辑，因为说是要结合公司的运维平台，实现运维自动化，所以没写相关代码，当出现用户中心问题时，让运维手动人工开启。

3.**策略+责任链**模式实现 redis/db 缓存降级，备份地址，熔断等降级**策略**，每次请求到网关，先执行缓存取还是正常请求等

内部调用外部   /Proxy/系统名ALM.../...url





